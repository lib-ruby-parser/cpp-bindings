name: test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: test on ${{ matrix.build.os }}
    runs-on: ${{ matrix.build.os }}
    strategy:
      fail-fast: false
      matrix:
        build:
          - { os: ubuntu-20.04, cc: clang-10, cxx: clang++-10, ld: ld.lld-10, run: "make test-all" }
          - { os: macos-latest, cc: clang   , cxx: clang++   , ld: ld       , run: "make test"     }

    steps:
      - name: setup compiler
        run: |
          echo "CC=${{ matrix.build.cc }}" >> $GITHUB_ENV
          echo "CXX=${{ matrix.build.cxx }}" >> $GITHUB_ENV
          echo "LD=${{ matrix.build.ld }}" >> $GITHUB_ENV

      - name: make sure compiler are available
        run: |
          which "$CC"
          which "$CXX"
          which "$LD"

      - name: install valgrind
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind

      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: true

      - name: install rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: setup
        run: make setup

      - name: run tests
        run: ${{ matrix.build.run }}
